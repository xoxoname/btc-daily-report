import os
import ccxt
from datetime import datetime

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                      í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ…                       â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
API_KEY       = os.environ['BITGET_API_KEY']
SECRET        = os.environ['BITGET_SECRET_KEY']
PASSPHRASE    = os.environ['BITGET_PASSPHRASE']
# (ì´ˆê¸° ìì‚° ëŒ€ë¹„ ë“±ë½ë¥  ê³„ì‚°ìš©â€”ì²˜ìŒ ì‹¤í–‰ ì‹œì ì˜ ìì‚°ì„ ì €ì¥í•´ë‘ì„¸ìš”)
INITIAL_EQUITY = float(os.environ.get('INITIAL_EQUITY', '0'))

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                    CCXT ê±°ë˜ì†Œ ì¸ìŠ¤í„´ìŠ¤                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
exchange = ccxt.bitget({
    'apiKey': API_KEY,
    'secret': SECRET,
    'password': PASSPHRASE,
    'options': {'defaultType': 'swap'},
})

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚               ë³´ìœ  í¬ì§€ì…˜(ë¯¸ì‹¤í˜„ PNL) ì¡°íšŒ                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
def fetch_open_positions():
    # ccxt ì˜ fetchPositions() ë¥¼ ì‚¬ìš©
    all_positions = exchange.fetchPositions()
    # contracts(ìˆ˜ëŸ‰)ì´ 0 ì´ ì•„ë‹Œ í¬ì§€ì…˜ë§Œ ë¦¬í„´
    return [p for p in all_positions if float(p['contracts']) != 0]

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                ì˜¤ëŠ˜ ì‹¤í˜„ PNL(ê°€ì •: 0ìœ¼ë¡œ ëŒ€ì²´)             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
def fetch_today_realized_pnl():
    # Bitget API ë¡œ accountBill(endPoint) ë“±ì„ ì§ì ‘ í˜¸ì¶œí•´ì„œ í•©ì‚° ê°€ëŠ¥
    # (í¸ì˜ìƒ ì—¬ê¸°ì„œëŠ” 0.0 ìœ¼ë¡œ ë¦¬í„´í•©ë‹ˆë‹¤)
    return 0.0

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                   í˜„ì¬ ìì‚°(Equity) ì¡°íšŒ                  â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
def get_equity():
    bal = exchange.fetchBalance({'type': 'future'})
    # futures ê³„ì •ì˜ USDT ì´ì•¡ ì¡°íšŒ
    return float(bal['total']['USDT'])

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                         ë©”ì¸ ë¡œì§                        â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
def main():
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    print(f"âœ… [BTC ì‹¤ì‹œê°„ ë¦¬í¬íŠ¸] {now}")
    print('----------------------------------------')

    # 1) ë¯¸ì‹¤í˜„ PNL ì¶œë ¥
    total_unrealized = 0.0
    for pos in fetch_open_positions():
        symbol         = pos['symbol']
        side           = pos['side']
        size           = float(pos['contracts'])
        entry_price    = float(pos['entryPrice'])
        unrealized_pnl = float(pos['info']['unrealisedPnl'])
        total_unrealized += unrealized_pnl
        # â˜… ë¯¸ì‹¤í˜„ PNL ì— +/â€“ í‘œì‹œë¥¼ ìœ„í•´ +.4f í¬ë§· ì§€ì • â˜…
        print(f"ğŸ“Š {symbol} | {side} | ìˆ˜ëŸ‰: {size:.4f} | ì§„ì…ê°€: {entry_price:.4f} | ë¯¸ì‹¤í˜„ PNL: {unrealized_pnl:+.4f} USDT")

    print(f"ğŸ§® ì´ ë¯¸ì‹¤í˜„ PNL: {total_unrealized:+.4f} USDT")

    # 2) ì‹¤í˜„ PNL ì¶œë ¥
    today_realized = fetch_today_realized_pnl()
    print(f"ğŸ’° ì˜¤ëŠ˜ ì‹¤í˜„ PNL: {today_realized:+.4f} USDT")

    # 3) ìì‚° ë° ë“±ë½ë¥  ì¶œë ¥
    equity     = get_equity()
    if INITIAL_EQUITY > 0:
        change_pct = (equity - INITIAL_EQUITY) / INITIAL_EQUITY * 100
        print(f"ğŸ’ í˜„ì¬ ìì‚°: {equity:.2f} USDT ({change_pct:+.2f}%)")
    else:
        print(f"ğŸ’ í˜„ì¬ ìì‚°: {equity:.2f} USDT")

if __name__ == '__main__':
    main()
